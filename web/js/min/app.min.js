var app=angular.module("kitIoT",["ngRoute"]).config(function($routeProvider){$routeProvider.when("/",{templateUrl:"views/mainView.html",controller:"mainCtrl"}).when("/dashboard",{templateUrl:"views/dashboardView.html",controller:"dashBoardCtrl"}).when("/map",{templateUrl:"views/mapView.html",controller:"mapCtrl"}).when("/disconnect",{templateUrl:"views/disconnectView.html",controller:"disconnectCtrl"}).otherwise({redirectTo:"/"})});app.run(function($rootScope,$location,Auth,Storage){$rootScope.$on("$routeChangeStart",function(event,next){$location.path(Auth.isLoggedIn()?Auth.isLoggedIn()&&!Auth.hasLonLat()?"/map":"views/disconnectView.html"===next.templateUrl?"/disconnect":"/dashboard":"/")}),$rootScope.$on("$routeChangeSuccess",function(){$rootScope.url=$location.path()}),$rootScope.lonLat=Storage.get("lonLat")}),app.controller("dashBoardCtrl",function($scope,$rootScope,$location,Storage,socket){"use strict";$scope.data={},$scope.msg="Conectando",$scope.connected=!1,$scope.internet=!1,$rootScope.name=Storage.get("name"),socket.on("data",function(m){$scope.data=m,$scope.connected=!0}),socket.on("button",function(m){$scope.data.button=m}),socket.on("disconnect",function(){$scope.connected=!1,$location.path("/disconnect")}),socket.on("internetConnection",function(m){$scope.internet=!0,$scope.msg=m.msg}),socket.on("no-internetConnection",function(m){$scope.internet=!1,$scope.msg=m.msg})}),app.controller("disconnectCtrl",function($scope){$scope.message="Parece que sue arduino não está conectado"}),app.controller("mainCtrl",function($scope,socket,$http,$location,Auth){"use strict";$scope.loginUser=function(){$scope.loading=!0,$http.post("/login",{name:$scope.name,email:$scope.email,login:$scope.login,pass:$scope.pass,tel:$scope.tel}).success(function(data){$scope.loading=!1,data.errors?($scope.errors=data.errors,$scope.mapErrors=data.mapErrors,$scope.error=null):data.error?($scope.errors=$scope.mapErrors=$scope.error=null,$scope.error="EHOSTUNREACH"===data.error.code?{msg:"Sem conexão com a internet"}:data.error):data.exceptionId?($scope.errors=$scope.mapErrors=$scope.error=null,$scope.error={msg:"Erro ao autenticar o login/senha"},$scope.mapErrors={login:"Erro ao autenticar o login/senha",pass:"Erro ao autenticar o login/senha"}):($scope.errors=$scope.mapErrors=$scope.error=null,Auth.login($scope.login,$scope.name,$scope.email,$scope.tel,data["x-m2m-authtoken"],data["x-csrf-token"]),$location.path("/map"))}).error(function(){$scope.loading=!1})}}),app.controller("mapCtrl",function($scope,$rootScope,$location,Storage,$http){"use strict";$scope.dashboard=function(){if($rootScope.lonLat){var lonLatShort=$rootScope.lonLat.toShortString();Storage.put("lonLat",lonLatShort),$scope.loading=!0,$http.post("/lonLat",{userProps:Storage.getUserProps()}).success(function(){$scope.loading=!1,$location.path("/dashboard")})}}}),app.service("Auth",function(Storage){"use strict";this.isLoggedIn=function(){return Storage.get("login")},this.hasLonLat=function(){return Storage.get("lonLat")},this.login=function(login,name,email,tel,m2mToken,csrfToken){Storage.put("login",login),Storage.put("name",name),Storage.put("email",email),Storage.put("tel",tel),Storage.put("x-m2m-authtoken",m2mToken),Storage.put("x-csrf-token",csrfToken)}}),app.factory("socket",function($rootScope){"use strict";var socket=io.connect();return{on:function(eventName,callback){socket.on(eventName,function(){var args=arguments;$rootScope.$apply(function(){callback.apply(socket,args)})})},emit:function(eventName,data,callback){socket.emit(eventName,data,function(){var args=arguments;$rootScope.$apply(function(){callback&&callback.apply(socket,args)})})}}}),app.service("Storage",function(){"use strict";this.put=function(name,data){localStorage.setItem(name,data)},this.get=function(name){var name=localStorage.getItem(name);return name?name:""},this.delete=function(name){localStorage.removeItem(name)},this.getUserProps=function(){var userProps={UserProps:[{name:"nome",value:this.get("name")},{name:"email",value:this.get("email")},{name:"tel",value:this.get("tel")}]};return this.get("lonLat")&&userProps.UserProps.push({name:"lonLat",value:this.get("lonLat")}),JSON.stringify(userProps)}}),app.directive("map",function($rootScope){return{restrict:"E",replace:!0,template:'<div class="map"></div>',link:function(scope,element,attrs){var user,map=new OpenLayers.Map(attrs.id),campus=new OpenLayers.Layer.Image("CPBR14","img/cpbr14.png",new OpenLayers.Bounds(0,0,2022,1009),new OpenLayers.Size(1011,505),{numZoomLevels:2}),markers=new OpenLayers.Layer.Markers("Markers"),lonLat=$rootScope.lonLat;map.addLayer(markers),lonLat&&(user=new OpenLayers.Marker(OpenLayers.LonLat.fromString(lonLat)),markers.addMarker(user)),map.events.register("click",map,function(e){lonLat=map.getLonLatFromViewPortPx(e.xy),user&&(markers.removeMarker(user),user.destroy()),user=new OpenLayers.Marker(lonLat),markers.addMarker(user),$rootScope.lonLat=lonLat}),map.addLayers([campus]),map.zoomToMaxExtent()}}});